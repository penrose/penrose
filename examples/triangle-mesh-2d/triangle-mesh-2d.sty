-- By default, use a canvas size suitable for a full-
-- column figure in a two-column ACM article.
canvas {
   width = 243
   height = 182
}

Colors {
   color black = rgba(0.,0.,0.,1.)
   color lightGray = rgba(.8,.8,.8,1.)
   color clear = rgba(0.,0.,0.,0.)
   color semiBlue = rgba( 27./255., 31./255., 138./255., .2 )
}

Global {
   scalar vertexRadius = 1.75
   scalar lineThickness = 1.

   shape box = Rectangle {
      center: (0.,0.)
      color: Colors.clear
      strokeColor: Colors.lightGray
      strokeWidth: 2.
      w: canvas.width
      h: canvas.height
   }

   string fontFamily = "Palatino"
   string fontSize = "9pt"
}

forall Vertex v {

   vec2 v.center = (?,?)

   -- black dot
   shape v.icon = Circle {
      color: Colors.black
      r: Global.vertexRadius
      center: v.center
   }

   -- label
   shape v.text = Text {
      center: (?,?)
      string: v.label
      fontFamily: Global.fontFamily
      fontSize: Global.fontSize
      fontStyle: "italic"
      color: Colors.black
   }

   -- invisible circle around label
   -- (used to prevent overlap)
   -- TODO we should really stop hacking
   -- TODO this, and just get bounding
   -- TODO boxes working for Text...
   shape v.bounds = Circle {
      center: v.text.center
      r: 7
      color: none()
   }

   -- make sure the dot and label are both
   -- on the canvas
   ensure contains( Global.box, v.icon )
   ensure contains( Global.box, v.bounds )

   -- keep the label near the dot
   encourage near( v.text, v.icon )
}

-- make sure vertex labels don't overlap
forall Vertex u; Vertex v {
   ensure disjoint( u.bounds, v.bounds )
}

forall Edge e; Vertex i; Vertex j
where e := MakeEdge(i,j) {
   
   -- black line between endpoints
   shape e.icon = Line {
      start: i.icon.center
      end: j.icon.center
      color: Colors.black
      thickness: Global.lineThickness
   }

   -- make sure edge doesn't cover the
   -- labels of its two endpoints
   ensure disjoint( i.bounds, e.icon, 1. )
   ensure disjoint( j.bounds, e.icon, 1. )
}

-- make sure no edge ij covers the label of
-- any other vertex k
forall Edge e; Vertex i; Vertex j; Vertex k
where e := MakeEdge(i,j) {
   
   ensure disjoint( k.bounds, e.icon, 1. )
}

forall Triangle t; Vertex i; Vertex j; Vertex k
where t := MakeTriangle(i,j,k)
{
   vec2 a = i.icon.center
   vec2 b = j.icon.center
   vec2 c = k.icon.center

   shape t.icon = Path {
      pathData: pathFromPoints("closed", [a,b,c])
      fill: Colors.semiBlue
      color: none()
   }

   -- XXX This sadly causes a lot of NaNs...
   -- Make sure triangles are positively
   -- oriented and not tiny, by making their
   -- signed area greater than some fixed constant.
   scalar A = cross2D( b-a, c-a )
   encourage lessThan( 2000., A )

   scalar aTheta = angleFrom( b-a, c-a )
   scalar bTheta = angleFrom( c-b, a-b )
   scalar cTheta = angleFrom( a-c, b-c )
   encourage equal( aTheta, toRadians(30.), 10000. )
   encourage equal( bTheta, toRadians(30.), 10000. )
   encourage equal( cTheta, toRadians(30.), 10000. )
}

forall Corner c; Vertex i; Vertex j; Vertex k
where c := MakeCorner(i,j,k) {

   vec2 p = i.center
   vec2 q = j.center
   vec2 r = k.center
   
   scalar s = .35 -- arc radius as fraction of edge length
   scalar R = s*norm(q-p)
   vec2 u = (q-p)/norm(q-p)
   vec2 v = (r-p)/norm(r-p)
   vec2 x = p + R*u
   vec2 y = p + R*v

   shape c.arc = Path {
      fill: none()
      color: Colors.black
      pathData: arc( "open", x, y, (R,R), 0., 0, 0 )
      strokeWidth: .75
   }

   shape c.arcFill = Path {
      fill: none()
      color: none()
      pathData: wedge( i.center, x, y, (R,R), 0., 0, 0 )
      fill: Colors.semiBlue
   }

   shape c.text = Text {
      string: c.label
      center: p + 1.5*R*(u+v)/2.
      fontSize: Global.fontSize
      fontFamily: Global.fontFamily
      fontStyle: "italic"
      color: Colors.black
   }
}

